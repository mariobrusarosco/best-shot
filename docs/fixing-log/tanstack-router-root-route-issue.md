# TanStack Router: Root Route Not Working in Production

**Date:** November 2, 2025  
**Issue:** Root route (`/`) returning 404 in production but working in localhost  
**Root Cause:** Incorrect file naming + stale route tree in production  
**Status:** âœ… Resolved

---

## ğŸ” Problem Description

### Symptom
- Visiting `https://best-shot-demo.mariobrusarosco.com/` returned a 404 error
- The same route worked perfectly on `localhost:5173/`
- Direct navigation to other routes (e.g., `/dashboard`, `/login`) also failed with 404
- The 404 page was the **app's custom 404**, not CloudFront's, meaning the app was loading but routing was broken

### Initial Confusion
At first, this appeared to be a CloudFront/S3 configuration issue since it only happened in production. However, the fact that the app's custom 404 page was showing (not CloudFront's generic 404) indicated the app was loading successfully - the issue was with client-side routing.

---

## ğŸ¯ Root Causes (Two Issues)

### Issue 1: Stale Route Tree in Production

**The Problem:**
- TanStack Router uses a generated file `src/routeTree.gen.ts` that contains the route configuration
- This file is generated by the `@tanstack/router-plugin` during development
- The file was **not being regenerated during CI/CD builds**
- Production was deploying with an **old version** of the route tree that didn't include the updated index route configuration

**Why This Happened:**
- The route tree file is generated during `vite dev` but not automatically during `vite build`
- Developers need to manually commit the generated route tree file
- If you update a route file but don't regenerate and commit the route tree, production gets out of sync

**Evidence:**
```bash
# Local route tree was updated
$ ls -lh src/routeTree.gen.ts
-rw-rw-r-- 1 mario mario 2.1M Nov  2 16:29 src/routeTree.gen.ts

# But git showed it was last committed weeks ago
$ git log --oneline -1 -- src/routeTree.gen.ts
158e6dd [FIX] Lint errors  # Old commit!
```

### Issue 2: Incorrect File Naming Convention

**The Problem:**
- The root index route was named `src/routes/index.route.tsx`
- TanStack Router expected it to be named `src/routes/index.tsx`
- With the `.route.tsx` suffix, the generator created: `path: ''` (empty string)
- With the `.tsx` suffix, it correctly generates: `path: '/'`

**Evidence:**
```typescript
// WRONG - Generated from index.route.tsx
const IndexRouteRoute = IndexRouteRouteImport.update({
  id: '/',
  path: '',  // âŒ Empty path doesn't match '/'
  getParentRoute: () => rootRouteImport,
})

// CORRECT - Generated from index.tsx
const IndexRoute = IndexRouteImport.update({
  id: '/',
  path: '/',  // âœ… Matches root URL
  getParentRoute: () => rootRouteImport,
})
```

**Why This Matters:**
- An empty `path: ''` means the route won't match the URL `/`
- The router falls through to the `notFoundComponent` defined in `__root.tsx`
- That's why users saw the custom 404 page

---

## ğŸ”§ The Solution

### Part 1: Automate Route Generation

**Installed TanStack Router CLI:**
```bash
yarn add -D @tanstack/router-cli
```

**Added Pre-Commit Hook:**
```bash
# .husky/pre-commit
yarn generate-routes
git add src/routeTree.gen.ts
yarn lint-staged
```

**Benefits:**
- âœ… Route tree regenerates automatically before every commit
- âœ… Updated route tree is always committed with route changes
- âœ… Production always has the latest routing configuration
- âœ… No manual intervention needed
- âœ… Impossible to forget to update the route tree

### Part 2: Fix File Naming

**Renamed the file:**
```bash
mv src/routes/index.route.tsx src/routes/index.tsx
```

**Why This Works:**
- TanStack Router's file-based routing has specific naming conventions
- `index.tsx` â†’ Root index route with `path: '/'`
- `index.route.tsx` â†’ Was being treated differently, generating `path: ''`

---

## ğŸ“š TanStack Router File Naming Conventions

### Standard Route Files

| File Name | Generated Route | Path |
|-----------|----------------|------|
| `index.tsx` | Root index | `/` |
| `about.tsx` | About page | `/about` |
| `posts.tsx` | Posts page | `/posts` |
| `posts/index.tsx` | Posts index | `/posts` |
| `posts/$id.tsx` | Post detail | `/posts/:id` |

### Layout Routes (Pathless)

| File Name | Generated Route | Path |
|-----------|----------------|------|
| `_layout.tsx` | Layout wrapper | No path (wraps children) |
| `_auth.tsx` | Auth layout | No path (wraps children) |

### Special Suffixes

| Suffix | Purpose | Example |
|--------|---------|---------|
| `.lazy.tsx` | Code-split route | `about.lazy.tsx` |
| `.route.tsx` | âš ï¸ **Avoid for index routes** | Creates issues with path generation |

---

## ğŸ“ Key Learnings

### 1. TanStack Router Route Generation is Build-Time

Unlike some routers that discover routes at runtime, TanStack Router:
- Scans your `src/routes` directory during development
- Generates a static `routeTree.gen.ts` file
- This file must be committed to git
- Production uses the committed file, not live generation

**Implication:** If you update routes but don't commit the route tree, production breaks.

### 2. File Naming Matters

TanStack Router uses file names to determine:
- Route paths
- Route hierarchy
- Whether a route is lazy-loaded
- Whether a route is a layout

**Always follow the official naming conventions** or you'll get unexpected behavior.

### 3. Development vs Production Behavior

**In Development:**
- Vite plugin watches for file changes
- Route tree regenerates automatically
- Hot module replacement works
- Everything feels "magic"

**In Production:**
- Uses the committed route tree file
- No live generation
- If route tree is stale, routes break
- No HMR to mask issues

**Lesson:** Always test production builds locally before deploying:
```bash
yarn build --mode demo
yarn preview
```

### 4. Debugging Client-Side Routing Issues

**Signs it's a routing issue (not server/CDN):**
- âœ… App loads (you see your UI, not a blank page)
- âœ… Network tab shows successful requests (200/304)
- âœ… You see your custom 404 page (not server's 404)
- âŒ `beforeLoad` hooks don't run
- âŒ Console logs in route files don't appear

**Debugging steps:**
1. Check if route tree is committed: `git log src/routeTree.gen.ts`
2. Check route tree content: Look for `path` values
3. Check file naming: Ensure it follows conventions
4. Test locally: `yarn build && yarn preview`
5. Check deployed bundle: Verify it matches local build

---

## ğŸš€ Prevention Strategy

### Automated Checks

**Pre-Commit Hook (Implemented):**
```bash
# .husky/pre-commit
yarn generate-routes
git add src/routeTree.gen.ts
yarn lint-staged
```

**CI/CD Validation (Recommended):**
```yaml
# .github/workflows/pr-validation.yml
- name: Check route tree is up-to-date
  run: |
    yarn generate-routes
    git diff --exit-code src/routeTree.gen.ts || \
      (echo "Route tree is out of date! Run 'yarn generate-routes' and commit." && exit 1)
```

### Development Workflow

1. **Create/modify route files** in `src/routes/`
2. **Pre-commit hook runs automatically:**
   - Generates route tree
   - Stages `routeTree.gen.ts`
   - Runs linting
3. **Commit includes both** route files and route tree
4. **CI/CD builds** with up-to-date route tree
5. **Production works** âœ…

---

## ğŸ“– Official Documentation References

- [TanStack Router - File-Based Routing](https://tanstack.com/router/latest/docs/framework/react/guide/file-based-routing)
- [TanStack Router - Route Trees](https://tanstack.com/router/latest/docs/framework/react/guide/route-trees)
- [TanStack Router CLI](https://tanstack.com/router/latest/docs/framework/react/guide/cli)

---

## ğŸ¯ Summary

**Problem:** Root route 404 in production  
**Cause 1:** Stale route tree file in git  
**Cause 2:** Wrong file naming (`index.route.tsx` vs `index.tsx`)  
**Solution 1:** Auto-generate routes on pre-commit  
**Solution 2:** Rename to `index.tsx`  
**Result:** âœ… Routes work in production  

**Time to Debug:** ~2 hours  
**Time to Fix:** 5 minutes  
**Lesson:** File naming conventions and build-time generation matter!

---

## ğŸ”— Related Issues

- [CloudFront SPA Routing 404 Fix](./cloudfront-spa-routing-404-fix.md) - Initial investigation (turned out to be unrelated)
- [Route Tree Generation](../guides/tanstack-router-guide.md) - Full guide (to be created)


